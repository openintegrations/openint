# This needs to be run from the root of the repo, run like so
# docker build . -f ./packages/airbyte/Dockerfile  -t venice/source-plaid:dev --progress plain

FROM node:18-alpine as base

RUN npm install -g pnpm

FROM base as dependencies

WORKDIR /venice

COPY tsconfig.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY ./patches/ ./patches
# Ideally we can do something with pnpm -r exec "copy package.json over to docker..."
# Short of that we just manually run this command instead
# find . -not -path '*/node_modules/*' -not -path '*/.next/*' -name 'package.json'

## TODO: This list would need to be generated by _generateconnectorsList.ts if we end up using the Dockerfile more
COPY ./connectors/connector-alphavantage/package.json ./connectors/connector-alphavantage/package.json
COPY ./connectors/connector-qbo/package.json ./connectors/connector-qbo/package.json
COPY ./connectors/connector-webhook/package.json ./connectors/connector-webhook/package.json
COPY ./connectors/connector-spreadsheet/package.json ./connectors/connector-spreadsheet/package.json
COPY ./connectors/connector-foreceipt/package.json ./connectors/connector-foreceipt/package.json
COPY ./connectors/connector-stripe/package.json ./connectors/connector-stripe/package.json
COPY ./connectors/connector-postgres/package.json ./connectors/connector-postgres/package.json
COPY ./connectors/connector-venmo/package.json ./connectors/connector-venmo/package.json
COPY ./connectors/connector-splitwise/package.json ./connectors/connector-splitwise/package.json
COPY ./connectors/connector-yodlee/package.json ./connectors/connector-yodlee/package.json
COPY ./connectors/connector-mongodb/package.json ./connectors/connector-mongodb/package.json
COPY ./connectors/connector-fs/package.json ./connectors/connector-fs/package.json
COPY ./connectors/connector-ramp/package.json ./connectors/connector-ramp/package.json
COPY ./connectors/connector-wise/package.json ./connectors/connector-wise/package.json
COPY ./connectors/connector-teller/package.json ./connectors/connector-teller/package.json
COPY ./connectors/connector-expensify/package.json ./connectors/connector-expensify/package.json
COPY ./connectors/connector-saltedge/package.json ./connectors/connector-saltedge/package.json
COPY ./connectors/connector-lunchmoney/package.json ./connectors/connector-lunchmoney/package.json
COPY ./connectors/connector-toggl/package.json ./connectors/connector-toggl/package.json
COPY ./connectors/connector-beancount/package.json ./connectors/connector-beancount/package.json
COPY ./connectors/connector-redis/package.json ./connectors/connector-redis/package.json
COPY ./connectors/connector-onebrick/package.json ./connectors/connector-onebrick/package.json
COPY ./connectors/connector-firebase/package.json ./connectors/connector-firebase/package.json
COPY ./connectors/connector-airtable/package.json ./connectors/connector-airtable/package.json
COPY ./connectors/connector-plaid/package.json ./connectors/connector-plaid/package.json
COPY ./connectors/connector-moota/package.json ./connectors/connector-moota/package.json
COPY ./package.json ./package.json
COPY ./packages/engine-backend/package.json ./packages/engine-backend/package.json
COPY ./packages/ui/package.json ./packages/ui/package.json
COPY ./packages/util/package.json ./packages/util/package.json
COPY ./packages/engine-frontend/package.json ./packages/engine-frontend/package.json
COPY ../kits/cdk/package.json ../kits/cdk/package.json
COPY ./packages/airbyte/package.json ./packages/airbyte/package.json
# Specifically excluded
# COPY ./apps/web/.next/package.json ./apps/web/.next/package.json
# COPY ./apps/web/package.json ./apps/web/package.json
# COPY ./apps/tests/package.json ./apps/tests/package.json
COPY ./apps/cli/package.json ./apps/cli/package.json
COPY ./apps/app-config/package.json ./apps/app-config/package.json

# Before copying the rest of the app so we don't need to reinstall pnpm on every build
RUN pnpm install

COPY ./apps/ ./apps
COPY ./packages/ ./packages
COPY ./connectors/ ./connectors


ENTRYPOINT ["node",  "--no-warnings", "--loader", "/venice/node_modules/tsx/dist/loader.js", "/venice/apps/cli/plaid-connector.ts"]
